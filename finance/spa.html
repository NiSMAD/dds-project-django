{% extends "finance/base.html" %}
{% block title %}Фронтенд (SPA){% endblock %}
{% block content %}
<h1 class="mb-4">Фронтенд через REST API</h1>

<!-- форма добавления записи -->
<form id="entry-form" class="card card-body mb-4">
  <div class="row g-2">
    <div class="col-md-2">
      <input type="date" class="form-control" name="date" required>
    </div>
    <div class="col-md-2">
      <input type="number" step="0.01" class="form-control" name="amount" placeholder="Сумма" required>
    </div>
    <div class="col-md-2">
      <input type="text" class="form-control" name="comment" placeholder="Комментарий">
    </div>
    <div class="col-md-2">
      <select name="status_id" class="form-select" required></select>
    </div>
    <div class="col-md-2">
      <select name="entry_type_id" class="form-select" required></select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100">Добавить</button>
    </div>
  </div>
</form>

<!-- таблица записей -->
<table class="table table-bordered" id="entries-table">
  <thead>
    <tr>
      <th>Дата</th>
      <th>Сумма</th>
      <th>Комментарий</th>
      <th>Статус</th>
      <th>Тип</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
const apiBase = "/api/";

async function fetchOptions() {
  const [statuses, types] = await Promise.all([
    fetch(apiBase + "statuses/").then(r => r.json()),
    fetch(apiBase + "types/").then(r => r.json())
  ]);
  fillSelect(document.querySelector('[name="status_id"]'), statuses);
  fillSelect(document.querySelector('[name="entry_type_id"]'), types);
}

function fillSelect(select, items) {
  select.innerHTML = "";
  items.forEach(i => {
    const opt = document.createElement("option");
    opt.value = i.id;
    opt.textContent = i.name;
    select.appendChild(opt);
  });
}

async function fetchEntries() {
  const data = await fetch(apiBase + "entries/").then(r => r.json());
  const tbody = document.querySelector("#entries-table tbody");
  tbody.innerHTML = "";
  data.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.amount}</td>
      <td>${e.comment || ""}</td>
      <td>${e.status.name}</td>
      <td>${e.entry_type.name}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("entry-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const obj = Object.fromEntries(formData.entries());
  await fetch(apiBase + "entries/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(obj)
  });
  form.reset();
  fetchEntries();
});

fetchOptions();
fetchEntries();
</script>
{% endblock %}
